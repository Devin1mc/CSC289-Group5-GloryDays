<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0-alpha1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='inventory.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> <!-- This is for the label font -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <!-- Inventory Header -->
    <div class="inventory-header">
        <img src="{{ url_for('static', filename='images/GloryDaysLogoCircle.jpg') }}" alt="Glory Days Logo" class="logo mb-3" />
        <span class="text-lg font-semibold">Employee: {{ first_name }}</span>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container mt-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by SKU or Game Name" onkeyup="filterInventory()" />
    </div>

    <!-- Add Item Button Outside Inventory Container -->
        <button class="add-item-btn" data-bs-toggle="modal" data-bs-target="#addItemModal">Add Item</button>

    <!-- Logout Button -->
    <button class="logout-btn" onclick="logoutUser()">Logout</button>
    
    <!-- Conditionally render Admin button -->
    {% if session.role == 'admin' %}
        <button class="admin-btn" onclick="window.location.href='{{ url_for('admin_page') }}'">Admin</button>
    {% endif %}

    <!-- Filter Buttons -->
    <div class="filter-buttons text-center mt-4">
        <button class="filter-btn" id="filter-sku">SKU</button>
        <button class="filter-btn" id="filter-name">Name</button>
        <button class="filter-btn" id="filter-platform">Platform</button>
        <button class="filter-btn" id="filter-quality">Quality</button>
        <button class="filter-btn reset-btn" id="reset-filters">Reset Filters</button>
    </div>

    <!-- Container for Inventory -->
    <div class="container mt-4">
      <!-- Container for Inventory Cards -->
      <div id="inventoryList" class="inventory-container">
          <!-- Inventory cards will be injected here -->
      </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">Add New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="platform" class="form-label">Platform</label>
                            <select class="form-select" id="platform" required>
                                <option value="Playstation">Playstation</option>
                                <option value="Xbox">Xbox</option>
                                <option value="PC">PC</option>
                                <option value="Switch">Switch</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="original_packaging" class="form-label">Original Packaging</label>
                            <input type="checkbox" id="original_packaging">
                        </div>
                        <div class="mb-3">
                            <label for="quality" class="form-label">Quality</label>
                            <select class="form-select" id="quality" required>
                                <option value="Good">Good</option>
                                <option value="Like New">Like New</option>
                                <option value="Old">Old</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" required>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="price" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Item</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


        <!-- Edit Item Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editItemForm">
                        <div class="mb-3">
                            <label for="edit_sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="edit_sku" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit_name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_platform" class="form-label">Platform</label>
                            <select class="form-select" id="edit_platform" required>
                                <option value="Playstation">Playstation</option>
                                <option value="Xbox">Xbox</option>
                                <option value="PC">PC</option>
                                <option value="Switch">Switch</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_original_packaging" class="form-label">Original Packaging</label>
                            <input type="checkbox" id="edit_original_packaging">
                        </div>
                        <div class="mb-3">
                            <label for="edit_quality" class="form-label">Quality</label>
                            <select class="form-select" id="edit_quality" required>
                                <option value="Good">Good</option>
                                <option value="Like New">Like New</option>
                                <option value="Old">Old</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="edit_stock" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="edit_price" required step="0.01">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Item</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Sell Item Modal -->
    <div class="modal fade" id="sellItemModal" tabindex="-1" aria-labelledby="sellItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sellItemModalLabel">Sell Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="sellItemForm">
                        <div class="mb-3">
                            <label for="sell_sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sell_sku" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="sell_quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="sell_quantity" required placeholder="Enter amount sold">
                        </div>
                        <div class="mb-3">
                            <label for="sell_price" class="form-label">Sale Price</label>
                            <input type="number" class="form-control" id="sell_price" required>
                        </div>
                        <button type="submit" class="btn btn-success">Sell Item</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Add Item functionality
        $('#addItemForm').on('submit', function(event) {
            event.preventDefault();
            let itemData = {
                sku: $('#sku').val(),
                name: $('#name').val(),
                platform: $('#platform').val(),
                original_packaging: $('#original_packaging').prop('checked') ? 1 : 0,
                quality: $('#quality').val(),
                stock: $('#stock').val(),
                price: $('#price').val()
            };

            $.ajax({
                url: '/add_inventory',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(itemData),
                success: function(response) {
                    alert(response.message);
                    $('#addItemModal').modal('hide');
                    loadInventory();  // Reload inventory
                },
                error: function(error) {
                    alert("Error adding item: " + error.responseText);
                }
            });
        });

        // Edit Item functionality
        $('#editItemForm').on('submit', function(event) {
            event.preventDefault();
            let itemData = {
                sku: $('#edit_sku').val(),
                name: $('#edit_name').val(),
                platform: $('#edit_platform').val(),
                original_packaging: $('#edit_original_packaging').prop('checked') ? 1 : 0,
                quality: $('#edit_quality').val(),
                stock: $('#edit_stock').val(),
                priceString: $('#edit_price').val(),
                price: parseFloat(priceString)
            };

            $.ajax({
                url: '/update_inventory',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(itemData),
                success: function(response) {
                    alert(response.message);
                    $('#editItemModal').modal('hide');
                    loadInventory();  // Reload inventory
                },
                error: function(error) {
                    alert("Error updating item: " + error.responseText);
                }
            });
        });

        // Sell Item functionality
        $('#sellItemForm').on('submit', function(event) {
            event.preventDefault();
            let itemData = {
                sku: $('#sell_sku').val(),
                quantity: $('#sell_quantity').val(),
                sale_price: $('#sell_price').val()
            };
        
            $.ajax({
                url: '/sell',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(itemData),
                success: function(response) {
                    alert(response.message);
                    $('#sellItemModal').modal('hide');
                    loadInventory();  // Reload inventory
                },
                error: function(error) {
                    alert("Error selling item: " + error.responseText);
                }
            });
        });

        // Delete Item functionality
        $(document).on('click', '.delete-btn', function() {
          let sku = $(this).data('sku'); // Get SKU from button attribute

          // Prompt user to type "Delete" to confirm
          let confirmation = prompt(`Type "Delete" to confirm item removal:`);

          if (confirmation === "Delete") {
              $.ajax({
                  url: '/delete_inventory',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({ sku: sku }),
                  success: function(response) {
                      alert(response.message);
                      loadInventory(); // Refresh inventory after deletion
                  },
                  error: function(error) {
                      alert("Error deleting item: " + error.responseText);
                  }
              });
          } else {
              alert("Deletion canceled. You must type 'Delete' exactly to confirm.");
          }
      });

        // Function to filter inventory by SKU or Game name as the user types
        function filterInventory() {
            let searchQuery = $('#searchInput').val().toLowerCase(); // Get the search input value
            $('.inventory-item').each(function() {
                let sku = $(this).find('.sku').text().toLowerCase(); // Get the SKU from the item card
                let name = $(this).find('.game-name').text().toLowerCase(); // Get the Game name from the item card
                if (sku.includes(searchQuery) || name.includes(searchQuery)) {
                    $(this).show(); // Show matching items
                } else {
                    $(this).hide(); // Hide non-matching items
                }
            });
        }

        // Load Inventory function to display items as cards
        let originalInventory = []; // Store the original inventory data

        // Load Inventory function to fetch data and store original inventory
        function loadInventory() {
            $.ajax({
                url: '/inventory_data',
                method: 'GET',
                success: function(data) {
                    originalInventory = data; // Save original data
                    displayInventory(data); // Display the inventory
                }
            });
        }
    
        // Function to display inventory items
        function displayInventory(data) {
            let inventoryCards = '';
            data.forEach(item => {
                inventoryCards += `
                    <div class="inventory-item">
                        <p class="sku text-sm text-muted">#${item.sku}</p>
                        <p class="game-name"><strong>Game:</strong> ${item.name}</p>
                        <p><strong>Platform:</strong> ${item.platform}</p>
                        <p><strong>Packaging:</strong> ${item.original_packaging ? 'Yes' : 'No'}</p>
                        <p><strong>Quality:</strong> ${item.quality}</p>
                        <p><strong>Stock:</strong> ${item.stock}</p>
                        <p><strong>Price:</strong> $${item.price}</p>
                        <div class="item-actions">
                            <button class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#editItemModal" 
                                data-sku="${item.sku}" 
                                data-name="${item.name}" 
                                data-platform="${item.platform}" 
                                data-packaging="${item.original_packaging}" 
                                data-quality="${item.quality}" 
                                data-stock="${item.stock}">
                                Edit
                            </button>
                            <button class="btn btn-danger btn-sm sell-btn" data-bs-toggle="modal" data-bs-target="#sellItemModal" 
                                data-sku="${item.sku}" 
                                data-stock="${item.stock}"
                                data-price="${item.price}">
                                Sell
                            </button>
                            <button class="btn btn-dark btn-sm delete-btn" data-sku="${item.sku}">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            $('#inventoryList').html(inventoryCards);
        }
    
        // 🔹 Event listeners for filter buttons
        $('#filter-sku').on('click', function() {
            let sortedData = [...originalInventory].sort((a, b) => a.sku.localeCompare(b.sku));
            displayInventory(sortedData);
        });
    
        $('#filter-name').on('click', function() {
            let sortedData = [...originalInventory].sort((a, b) => a.name.localeCompare(b.name));
            displayInventory(sortedData);
        });
    
        $('#filter-platform').on('click', function() {
            let sortedData = [...originalInventory].sort((a, b) => a.platform.localeCompare(b.platform));
            displayInventory(sortedData);
        });
    
        $('#filter-quality').on('click', function() {
            let sortedData = [...originalInventory].sort((a, b) => a.quality.localeCompare(b.quality));
            displayInventory(sortedData);
        });
    
        // 🔹 Reset Filters Button - Restores the original inventory list
        $('#reset-filters').on('click', function() {
            displayInventory(originalInventory);
        });
    
        // 🔹 Load Inventory on Page Load
        $(document).ready(function() {
            loadInventory();
        });

        function logoutUser() {
            fetch("{{ url_for('auth.logout') }}", {
                method: "GET",
                credentials: "same-origin"
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url; // Redirect to login page
                }
            })
            .catch(error => console.error("Error logging out:", error));
        }
        // Function to generate a new SKU
        function generateNewSku() {
        // Fetch the latest SKU prefix (first 3 digits)
        $.ajax({
            url: '/get_latest_sku',
            method: 'GET',
            success: function(response) {
                let latestSkuPrefix = response.latest_sku_prefix;
                
                // Get the numeric part and increment it by 1
                let skuNumber = parseInt(latestSkuPrefix) + 1;
                
                // Ensure the new SKU has 3 digits (e.g., 001, 002, etc.)
                let newSkuPrefix = skuNumber.toString().padStart(3, '0');
                
                // Get the selected platform and map it to the corresponding letter
                let platform = $('#platform').val().toUpperCase();
                let platformCode = '';

                switch (platform) {
                    case 'playstation':
                        platformCode = 'P';
                        break;
                    case 'xbox':
                        platformCode = 'X';
                        break;
                    case 'pc':
                        platformCode = 'C';
                        break;
                    case 'switch':
                        platformCode = 'S';
                        break;
                    default:
                        platformCode = 'O'; // Default to 'O' for "Other"
                }

                // Check if the checkbox for original packaging is checked ('1' for Yes, '0' for No)
                let originalPackaging = $('#original_packaging').prop('checked') ? '1' : '0';
                
                // Get the selected quality (either 'Good', 'Like New', or 'Old')
                let quality = $('#quality').val().toUpperCase();
                let qualityCode = '';

                switch (quality) {
                    case 'good':
                        qualityCode = 'G';
                        break;
                    case 'like new':
                        qualityCode = 'L';
                        break;
                    case 'old':
                        qualityCode = 'O';
                        break;
                }

                // Generate the new SKU
                let newSku = newSkuPrefix + platformCode + originalPackaging + qualityCode;
                
                // Set the new SKU in the form (for add-item modal)
                $('#sku').val(newSku);

                // If it's the edit-item modal, populate the SKU field too
                $('#edit_sku').val(newSku);
            },
            error: function(error) {
                alert('Error fetching latest SKU: ' + error.responseText);
            }
        });
    }

    // Open modal for add-item and edit-item and generate SKU
    $('#addItemModal').on('show.bs.modal', function () {
        generateNewSku(); // Generate and display SKU when add-item modal opens
    });


        $(document).on('click', '.edit-btn', function() {
            // Get the data attributes from the clicked edit button
            let sku = $(this).data('sku');
            let name = $(this).data('name');
            let platform = $(this).data('platform');
            let originalPackaging = $(this).data('packaging');
            let quality = $(this).data('quality');
            let stock = $(this).data('stock');

            // Populate the modal with the item details
            $('#edit_sku').val(sku);
            $('#edit_name').val(name);
            $('#edit_platform').val(platform);
            $('#edit_original_packaging').prop('checked', originalPackaging);
            $('#edit_quality').val(quality);
            $('#edit_stock').val(stock);
        });



    </script>
</body>
</html>